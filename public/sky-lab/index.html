<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><title>Sky Lab - Stargazer</title><meta name=description content="Interactive sky viewer for stargazing."><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons" rel=stylesheet type=text/css><link rel=icon type=image/x-icon href=/sky-lab/static/favicon.ico><link href=/sky-lab/static/css/app.2cc6d43db3447e7c38ea7dfe7006ca91.css rel=stylesheet>
<style>
/* ========== HIDE ORIGINAL UI ========== */
.bottom-button, .tbtcontainer, .tmenubt { display: none !important; }
.v-navigation-drawer--right { display: none !important; }
#stel-canvas { height: 100vh !important; }
.v-toolbar { display: none !important; }

/* ========== MINIMAL TOOLBAR ========== */
#skylab-toolbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: center;
  gap: 12px;
  padding: 16px 20px;
  padding-bottom: max(16px, env(safe-area-inset-bottom));
  background: linear-gradient(transparent, rgba(0,0,0,0.85));
  z-index: 9999;
}

.toolbar-btn {
  width: 52px;
  height: 52px;
  border: none;
  border-radius: 50%;
  background: rgba(255,255,255,0.12);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.1);
}

.toolbar-btn:hover, .toolbar-btn:active {
  background: rgba(255,255,255,0.22);
  transform: scale(1.08);
}

.toolbar-btn.active {
  background: rgba(100,149,237,0.5);
  border-color: rgba(100,149,237,0.6);
  box-shadow: 0 0 16px rgba(100,149,237,0.4);
}

.toolbar-btn svg {
  width: 24px;
  height: 24px;
}

/* ========== SETTINGS PANEL ========== */
#skylab-settings {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  max-height: 55vh;
  background: rgba(15,15,25,0.96);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-radius: 20px 20px 0 0;
  z-index: 10000;
  transform: translateY(0);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow-y: auto;
  border-top: 1px solid rgba(255,255,255,0.1);
}

#skylab-settings.panel-hidden {
  transform: translateY(100%);
  pointer-events: none;
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 24px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  font-size: 17px;
  font-weight: 500;
  color: #fff;
  position: sticky;
  top: 0;
  background: rgba(15,15,25,0.98);
}

.close-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  color: #fff;
  font-size: 20px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover { background: rgba(255,255,255,0.2); }

.panel-content {
  padding: 16px 24px;
  padding-bottom: max(24px, env(safe-area-inset-bottom));
}

.setting-group {
  margin-bottom: 24px;
}

.group-title {
  font-size: 11px;
  font-weight: 600;
  color: rgba(255,255,255,0.4);
  letter-spacing: 1.2px;
  margin-bottom: 12px;
  text-transform: uppercase;
}

.toggle-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  color: #fff;
  cursor: pointer;
  font-size: 15px;
}

.toggle-row input[type="checkbox"] {
  width: 48px;
  height: 28px;
  appearance: none;
  -webkit-appearance: none;
  background: rgba(255,255,255,0.15);
  border-radius: 14px;
  position: relative;
  cursor: pointer;
  transition: background 0.25s;
}

.toggle-row input[type="checkbox"]:checked {
  background: rgba(100,149,237,0.7);
}

.toggle-row input[type="checkbox"]::after {
  content: '';
  position: absolute;
  width: 22px;
  height: 22px;
  background: #fff;
  border-radius: 50%;
  top: 3px;
  left: 3px;
  transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.toggle-row input[type="checkbox"]:checked::after {
  transform: translateX(20px);
}

.info-row {
  padding: 12px 0;
  color: rgba(255,255,255,0.85);
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.info-row input {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 10px;
  padding: 10px 14px;
  color: #fff;
  font-size: 15px;
  flex: 1;
  min-width: 120px;
}

.info-row input:focus {
  outline: none;
  border-color: rgba(100,149,237,0.5);
}

/* ========== COMPACT INFO CARD ========== */
#skylab-info-card {
  position: fixed;
  top: max(20px, env(safe-area-inset-top));
  left: 16px;
  background: rgba(15,15,25,0.92);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border-radius: 14px;
  padding: 14px 18px;
  z-index: 9998;
  max-width: 220px;
  transition: opacity 0.25s, transform 0.25s;
  border: 1px solid rgba(255,255,255,0.1);
}

#skylab-info-card.card-hidden {
  opacity: 0;
  transform: translateY(-12px);
  pointer-events: none;
}

.card-name {
  font-size: 17px;
  font-weight: 600;
  color: #fff;
  margin-bottom: 4px;
}

.card-type {
  font-size: 13px;
  color: rgba(255,255,255,0.55);
  margin-bottom: 10px;
}

.card-details {
  display: flex;
  flex-direction: column;
  gap: 3px;
  font-size: 13px;
  color: rgba(255,255,255,0.75);
  font-family: 'SF Mono', 'Roboto Mono', monospace;
}

/* ========== COMPASS INDICATOR ========== */
.compass-paused {
  opacity: 0.5 !important;
}

/* ========== SEARCH OVERLAY ========== */
#skylab-search {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  padding: max(16px, env(safe-area-inset-top)) 16px 16px;
  background: linear-gradient(rgba(0,0,0,0.9), transparent);
  z-index: 9999;
  transform: translateY(0);
  transition: transform 0.3s, opacity 0.3s;
}

#skylab-search.search-hidden {
  transform: translateY(-100%);
  opacity: 0;
  pointer-events: none;
}

#skylab-search input {
  width: 100%;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: 14px 18px;
  color: #fff;
  font-size: 16px;
}

#skylab-search input::placeholder {
  color: rgba(255,255,255,0.5);
}

#skylab-search input:focus {
  outline: none;
  border-color: rgba(100,149,237,0.6);
  background: rgba(255,255,255,0.18);
}
</style>
</head><body><div id=app></div>

<!-- Minimal Toolbar -->
<div id="skylab-toolbar">
  <button id="btn-search" class="toolbar-btn" title="Search">
    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
  </button>
  <button id="btn-constellations" class="toolbar-btn" title="Constellations">
    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l2.4 7.4H22l-6.2 4.5 2.4 7.4L12 17l-6.2 4.3 2.4-7.4L2 9.4h7.6z"/></svg>
  </button>
  <button id="btn-compass" class="toolbar-btn" title="Compass Mode">
    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/></svg>
  </button>
  <button id="btn-settings" class="toolbar-btn" title="Settings">
    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
  </button>
</div>

<!-- Settings Panel -->
<div id="skylab-settings" class="panel-hidden">
  <div class="panel-header">
    <span>Settings</span>
    <button id="btn-close-settings" class="close-btn">&times;</button>
  </div>
  <div class="panel-content">
    <div class="setting-group">
      <div class="group-title">View</div>
      <label class="toggle-row">
        <span>Atmosphere</span>
        <input type="checkbox" id="toggle-atmosphere" checked>
      </label>
      <label class="toggle-row">
        <span>Landscape</span>
        <input type="checkbox" id="toggle-landscape" checked>
      </label>
      <label class="toggle-row">
        <span>Deep Sky Objects</span>
        <input type="checkbox" id="toggle-dsos">
      </label>
    </div>
    <div class="setting-group">
      <div class="group-title">Grids</div>
      <label class="toggle-row">
        <span>Azimuthal</span>
        <input type="checkbox" id="toggle-azimuthal">
      </label>
      <label class="toggle-row">
        <span>Equatorial</span>
        <input type="checkbox" id="toggle-equatorial">
      </label>
    </div>
    <div class="setting-group">
      <div class="group-title">Time &amp; Location</div>
      <div class="info-row" id="location-display">Detecting location...</div>
      <div class="info-row">
        <input type="date" id="input-date">
        <input type="time" id="input-time">
      </div>
    </div>
  </div>
</div>

<!-- Compact Object Info Card -->
<div id="skylab-info-card" class="card-hidden">
  <div class="card-name" id="card-name">Object Name</div>
  <div class="card-type" id="card-type">Type</div>
  <div class="card-details">
    <span id="card-mag">Mag: --</span>
    <span id="card-pos">Alt: --° Az: --°</span>
  </div>
</div>

<!-- Search Overlay -->
<div id="skylab-search" class="search-hidden">
  <input type="text" id="search-input" placeholder="Search stars, planets, nebulae...">
</div>
<script>
// Error handling to prevent flickering from ephemeris loading errors
(function() {
  var errorShown = false;
  var suppressPatterns = ['Unknown chunk type', 'eph_load', 'abort(', 'eph-file.c'];
  // Block .eph file requests that cause parsing errors
  var blockUrlPatterns = ['.eph', 'gaia_dr2'];

  function shouldSuppress(msg) {
    if (typeof msg !== 'string') msg = String(msg);
    for (var i = 0; i < suppressPatterns.length; i++) {
      if (msg.indexOf(suppressPatterns[i]) !== -1) return true;
    }
    return false;
  }

  function shouldBlockUrl(url) {
    if (typeof url !== 'string') return false;
    for (var i = 0; i < blockUrlPatterns.length; i++) {
      if (url.indexOf(blockUrlPatterns[i]) !== -1) return true;
    }
    return false;
  }

  function showWarningOnce() {
    if (!errorShown) {
      errorShown = true;
      console.info('[Sky Lab] Extended star catalog disabled - using core rendering');
    }
  }

  // Intercept XHR to block problematic .eph file requests
  var OrigXHR = window.XMLHttpRequest;
  window.XMLHttpRequest = function() {
    var xhr = new OrigXHR();
    var origOpen = xhr.open;
    var origSend = xhr.send;
    xhr._blocked = false;

    xhr.open = function(method, url) {
      if (shouldBlockUrl(url)) {
        showWarningOnce();
        this._blocked = true;
        // Don't call origOpen for blocked URLs - prevent request entirely
        return;
      }
      return origOpen.apply(this, arguments);
    };

    xhr.send = function() {
      if (this._blocked) {
        var self = this;
        // Simulate a failed request without actually making one
        setTimeout(function() {
          Object.defineProperty(self, 'status', { value: 0 });
          Object.defineProperty(self, 'readyState', { value: 4 });
          Object.defineProperty(self, 'response', { value: null });
          Object.defineProperty(self, 'responseText', { value: '' });
          if (self.onreadystatechange) self.onreadystatechange();
          if (self.onerror) self.onerror(new Error('Blocked'));
          if (self.onloadend) self.onloadend();
        }, 0);
        return;
      }
      return origSend.apply(this, arguments);
    };
    return xhr;
  };

  // Intercept fetch() to block problematic .eph file requests
  var origFetch = window.fetch;
  window.fetch = function(url, options) {
    var urlStr = typeof url === 'string' ? url : (url && url.url ? url.url : String(url));
    if (shouldBlockUrl(urlStr)) {
      showWarningOnce();
      // Return a rejected promise or empty response
      return Promise.resolve(new Response(null, { status: 404, statusText: 'Blocked' }));
    }
    return origFetch.apply(this, arguments);
  };

  // Store original console methods
  var origLog = console.log;
  var origWarn = console.warn;
  var origError = console.error;

  // Override console methods to suppress ephemeris errors
  console.log = function() {
    var msg = Array.prototype.join.call(arguments, ' ');
    if (shouldSuppress(msg)) { showWarningOnce(); return; }
    origLog.apply(console, arguments);
  };
  console.warn = function() {
    var msg = Array.prototype.join.call(arguments, ' ');
    if (shouldSuppress(msg)) { showWarningOnce(); return; }
    origWarn.apply(console, arguments);
  };
  console.error = function() {
    var msg = Array.prototype.join.call(arguments, ' ');
    if (shouldSuppress(msg)) { showWarningOnce(); return; }
    origError.apply(console, arguments);
  };

  // Global error handler
  window.addEventListener('error', function(e) {
    if (e.message && shouldSuppress(e.message)) {
      e.preventDefault();
      showWarningOnce();
      return true;
    }
  });

  window.addEventListener('unhandledrejection', function(e) {
    if (e.reason && shouldSuppress(String(e.reason))) {
      e.preventDefault();
      showWarningOnce();
      return true;
    }
  });

  // Pre-configure StelWebEngine module
  window.StelWebEngine = {
    print: function(text) {
      if (shouldSuppress(text)) { showWarningOnce(); return; }
      origLog.call(console, text);
    },
    printErr: function(text) {
      if (shouldSuppress(text)) { showWarningOnce(); return; }
      origWarn.call(console, text);
    },
    onAbort: function(what) {
      showWarningOnce();
      // Don't throw - swallow the abort
    }
  };
})();
</script>
<script type=text/javascript src=/sky-lab/static/js/manifest.c7a1f17f07cae11d7ca9.js></script><script type=text/javascript src=/sky-lab/static/js/vendor.a46a2ffdde3ffbf8a523.js></script><script type=text/javascript src=/sky-lab/static/js/app.14b094410fbcd537a6ca.js></script>
<script>
// ========== SKY LAB MINIMAL UI ==========
(function() {
  'use strict';

  // Wait for Stellarium to initialize
  function waitForStel(callback, maxWait) {
    maxWait = maxWait || 10000;
    var startTime = Date.now();
    var checkInterval = setInterval(function() {
      if (window.$stel && window.$stel.core) {
        clearInterval(checkInterval);
        callback();
      } else if (Date.now() - startTime > maxWait) {
        clearInterval(checkInterval);
        console.warn('[Sky Lab] Stellarium not found after timeout');
      }
    }, 100);
  }

  waitForStel(function() {
    var stel = window.$stel;
    console.log('[Sky Lab] Minimal UI initializing...');

    // ========== DOM ELEMENTS ==========
    var btnSearch = document.getElementById('btn-search');
    var btnConstellations = document.getElementById('btn-constellations');
    var btnCompass = document.getElementById('btn-compass');
    var btnSettings = document.getElementById('btn-settings');
    var settingsPanel = document.getElementById('skylab-settings');
    var btnCloseSettings = document.getElementById('btn-close-settings');
    var searchOverlay = document.getElementById('skylab-search');
    var searchInput = document.getElementById('search-input');

    // Toggles
    var toggleAtmosphere = document.getElementById('toggle-atmosphere');
    var toggleLandscape = document.getElementById('toggle-landscape');
    var toggleDsos = document.getElementById('toggle-dsos');
    var toggleAzimuthal = document.getElementById('toggle-azimuthal');
    var toggleEquatorial = document.getElementById('toggle-equatorial');

    // Date/Time/Location
    var inputDate = document.getElementById('input-date');
    var inputTime = document.getElementById('input-time');
    var locationDisplay = document.getElementById('location-display');

    // Info card
    var infoCard = document.getElementById('skylab-info-card');
    var cardName = document.getElementById('card-name');
    var cardType = document.getElementById('card-type');
    var cardMag = document.getElementById('card-mag');
    var cardPos = document.getElementById('card-pos');

    // ========== SYNC INITIAL STATES ==========
    function syncToggles() {
      if (stel.core.atmosphere) toggleAtmosphere.checked = stel.core.atmosphere.visible;
      if (stel.core.landscape) toggleLandscape.checked = stel.core.landscape.visible;
      if (stel.core.dsos) toggleDsos.checked = stel.core.dsos.visible;
      if (stel.core.lines && stel.core.lines.azimuthal) toggleAzimuthal.checked = stel.core.lines.azimuthal.visible;
      if (stel.core.lines && stel.core.lines.equatorial) toggleEquatorial.checked = stel.core.lines.equatorial.visible;
      if (stel.core.constellations && stel.core.constellations.lines) {
        btnConstellations.classList.toggle('active', stel.core.constellations.lines.visible);
      }
    }

    function syncDateTime() {
      try {
        var d = new Date();
        if (stel.core.observer && typeof stel.core.observer.utc !== 'undefined') {
          d.setMJD(stel.core.observer.utc);
        }
        inputDate.value = d.toISOString().split('T')[0];
        inputTime.value = d.toTimeString().slice(0, 5);
      } catch (e) {
        console.warn('[Sky Lab] DateTime sync error:', e);
      }
    }

    function updateLocationDisplay() {
      try {
        var obs = stel.core.observer;
        if (obs && typeof obs.latitude !== 'undefined') {
          var lat = (obs.latitude * 180 / Math.PI).toFixed(2);
          var lon = (obs.longitude * 180 / Math.PI).toFixed(2);
          locationDisplay.textContent = lat + ', ' + lon;
        }
      } catch (e) {
        locationDisplay.textContent = 'Location unavailable';
      }
    }

    // Initial sync
    setTimeout(function() {
      syncToggles();
      syncDateTime();
      updateLocationDisplay();
    }, 500);

    // ========== SETTINGS PANEL ==========
    btnSettings.addEventListener('click', function() {
      var isHidden = settingsPanel.classList.contains('panel-hidden');
      if (isHidden) {
        settingsPanel.classList.remove('panel-hidden');
        syncToggles();
        syncDateTime();
        updateLocationDisplay();
      } else {
        settingsPanel.classList.add('panel-hidden');
      }
    });

    btnCloseSettings.addEventListener('click', function() {
      settingsPanel.classList.add('panel-hidden');
    });

    // ========== CONSTELLATIONS TOGGLE ==========
    btnConstellations.addEventListener('click', function() {
      if (stel.core.constellations && stel.core.constellations.lines) {
        var newState = !stel.core.constellations.lines.visible;
        stel.core.constellations.lines.visible = newState;
        btnConstellations.classList.toggle('active', newState);
      }
    });

    // ========== SETTINGS TOGGLES ==========
    toggleAtmosphere.addEventListener('change', function() {
      if (stel.core.atmosphere) stel.core.atmosphere.visible = this.checked;
    });
    toggleLandscape.addEventListener('change', function() {
      if (stel.core.landscape) stel.core.landscape.visible = this.checked;
    });
    toggleDsos.addEventListener('change', function() {
      if (stel.core.dsos) stel.core.dsos.visible = this.checked;
    });
    toggleAzimuthal.addEventListener('change', function() {
      if (stel.core.lines && stel.core.lines.azimuthal) stel.core.lines.azimuthal.visible = this.checked;
    });
    toggleEquatorial.addEventListener('change', function() {
      if (stel.core.lines && stel.core.lines.equatorial) stel.core.lines.equatorial.visible = this.checked;
    });

    // ========== DATE/TIME ==========
    inputDate.addEventListener('change', function() {
      try {
        var d = new Date(this.value + 'T' + inputTime.value);
        if (!isNaN(d.getTime()) && typeof d.getMJD === 'function') {
          stel.core.observer.utc = d.getMJD();
        }
      } catch (e) { console.warn('[Sky Lab] Date change error:', e); }
    });

    inputTime.addEventListener('change', function() {
      try {
        var d = new Date(inputDate.value + 'T' + this.value);
        if (!isNaN(d.getTime()) && typeof d.getMJD === 'function') {
          stel.core.observer.utc = d.getMJD();
        }
      } catch (e) { console.warn('[Sky Lab] Time change error:', e); }
    });

    // ========== SEARCH ==========
    btnSearch.addEventListener('click', function() {
      var isHidden = searchOverlay.classList.contains('search-hidden');
      if (isHidden) {
        searchOverlay.classList.remove('search-hidden');
        searchInput.focus();
      } else {
        searchOverlay.classList.add('search-hidden');
        searchInput.blur();
      }
    });

    // Try to use the original search functionality
    searchInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        var query = this.value.trim();
        if (query) {
          // Try to find the original search and trigger it
          var origSearch = document.querySelector('.skysource-search input, .v-text-field input');
          if (origSearch) {
            origSearch.value = query;
            origSearch.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }
        searchOverlay.classList.add('search-hidden');
      } else if (e.key === 'Escape') {
        searchOverlay.classList.add('search-hidden');
      }
    });

    // Close search when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchOverlay.contains(e.target) && e.target !== btnSearch && !btnSearch.contains(e.target)) {
        searchOverlay.classList.add('search-hidden');
      }
    });

    // ========== COMPASS / AR MODE ==========
    var compassActive = false;
    var compassPaused = false;

    function requestOrientationPermission() {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        return DeviceOrientationEvent.requestPermission();
      }
      return Promise.resolve('granted');
    }

    function updateViewFromOrientation(event) {
      if (!compassActive || compassPaused) return;

      var alpha = event.alpha;
      var beta = event.beta;

      if (alpha === null || beta === null) return;

      // alpha: compass direction (0 = North, 90 = East)
      // beta: front-back tilt (-180 to 180, 90 = phone upright)
      var azimuth = (360 - alpha) * (Math.PI / 180);
      var altitude = (90 - Math.abs(beta)) * (Math.PI / 180);
      if (beta < 0) altitude = -altitude;

      // Clamp altitude
      altitude = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, altitude));

      // Convert to cartesian for lookat (azalt frame)
      var x = Math.cos(altitude) * Math.sin(azimuth);
      var y = Math.cos(altitude) * Math.cos(azimuth);
      var z = Math.sin(altitude);

      try {
        stel.core.lookat([x, -y, z], 0);
      } catch (e) {}
    }

    function startCompass() {
      requestOrientationPermission().then(function(permission) {
        if (permission === 'granted') {
          compassActive = true;
          compassPaused = false;
          btnCompass.classList.add('active');
          btnCompass.classList.remove('compass-paused');
          window.addEventListener('deviceorientation', updateViewFromOrientation);
          console.log('[Sky Lab] Compass mode started');
        } else {
          alert('Motion sensor permission denied. Please enable in device settings.');
        }
      }).catch(function(err) {
        console.error('[Sky Lab] Compass permission error:', err);
        // Try without permission on Android
        compassActive = true;
        compassPaused = false;
        btnCompass.classList.add('active');
        window.addEventListener('deviceorientation', updateViewFromOrientation);
      });
    }

    function stopCompass() {
      compassActive = false;
      compassPaused = false;
      btnCompass.classList.remove('active');
      btnCompass.classList.remove('compass-paused');
      window.removeEventListener('deviceorientation', updateViewFromOrientation);
      console.log('[Sky Lab] Compass mode stopped');
    }

    function pauseCompass() {
      if (compassActive && !compassPaused) {
        compassPaused = true;
        btnCompass.classList.add('compass-paused');
      }
    }

    function resumeCompass() {
      if (compassActive && compassPaused) {
        compassPaused = false;
        btnCompass.classList.remove('compass-paused');
      }
    }

    btnCompass.addEventListener('click', function() {
      if (!compassActive) {
        startCompass();
      } else if (compassPaused) {
        resumeCompass();
      } else {
        stopCompass();
      }
    });

    // Pause compass on user interaction
    var canvas = document.getElementById('stel-canvas') || document.querySelector('canvas');
    if (canvas) {
      canvas.addEventListener('mousedown', pauseCompass);
      canvas.addEventListener('touchstart', pauseCompass);
    }

    // ========== OBJECT INFO CARD ==========
    function updateInfoCard() {
      try {
        var selection = stel.core.selection;
        if (!selection || !selection.nsid) {
          infoCard.classList.add('card-hidden');
          return;
        }

        selection.update();

        // Name
        var name = 'Unknown';
        if (selection.designations && selection.designations.length > 0) {
          name = selection.designations[0];
        } else if (selection.names && selection.names.length > 0) {
          name = selection.names[0];
        }
        cardName.textContent = name;

        // Type
        var type = selection.type_name || (selection.types && selection.types[0]) || 'Object';
        cardType.textContent = type;

        // Magnitude
        var mag = selection.vmag;
        cardMag.textContent = (mag && !isNaN(mag)) ? 'Mag: ' + mag.toFixed(2) : 'Mag: --';

        // Position
        var azalt = selection.azalt;
        if (azalt && azalt.length >= 2) {
          var az = ((azalt[0] * 180 / Math.PI) + 360) % 360;
          var alt = azalt[1] * 180 / Math.PI;
          cardPos.textContent = 'Alt: ' + alt.toFixed(0) + ' Az: ' + az.toFixed(0);
        } else {
          cardPos.textContent = 'Alt: -- Az: --';
        }

        infoCard.classList.remove('card-hidden');
      } catch (e) {
        infoCard.classList.add('card-hidden');
      }
    }

    // Poll for selection changes
    var lastSelectionId = null;
    setInterval(function() {
      try {
        var sel = stel.core.selection;
        var selId = sel ? sel.nsid : null;
        if (selId !== lastSelectionId) {
          lastSelectionId = selId;
          updateInfoCard();
        } else if (selId) {
          // Update position continuously
          updateInfoCard();
        }
      } catch (e) {}
    }, 500);

    // Dismiss card on tap
    infoCard.addEventListener('click', function() {
      try {
        stel.core.selection = null;
      } catch (e) {}
      infoCard.classList.add('card-hidden');
    });

    // Update location periodically
    setInterval(updateLocationDisplay, 5000);

    console.log('[Sky Lab] Minimal UI initialized');
  });
})();
</script>
</body></html>